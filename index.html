<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Project Dashboard</title>
    
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 800px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }
        
        h1 { text-align: center; color: #333; margin-bottom: 10px; font-size: 24px; }
        
        .status-bar { padding: 8px; border-radius: 6px; margin-bottom: 15px; text-align: center; font-size: 13px; font-weight: bold;}
        .status-bar.ready { background: #d4edda; color: #155724; }
        .status-bar.loading { background: #fff3cd; color: #856404; }
        .status-bar.error { background: #f8d7da; color: #721c24; }
        
        .chat-box {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        
        .message { margin-bottom: 15px; padding: 12px 15px; border-radius: 8px; font-size: 14px; line-height: 1.5; }
        .user-message { background: #667eea; color: white; align-self: flex-end; margin-left: 50px; text-align: right; }
        .ai-message { background: #e0e0e0; color: #333; margin-right: 50px; }
        
        /* --- CHART & TABLE STYLES --- */
        .chart-container { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-top: 10px; }
        
        .table-container {
            overflow-x: auto; margin-top: 10px; background: white;
            border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .chat-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .chat-table th { background-color: #667eea; color: white; text-align: left; padding: 10px; }
        .chat-table td { border-bottom: 1px solid #eee; padding: 8px 10px; color: #333; }
        .chat-table tr:nth-child(even) { background-color: #f8f9fa; }
        
        /* --- INPUTS & BUTTONS --- */
        .input-group { display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        
        button { padding: 12px 20px; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:disabled { background: #ccc !important; cursor: not-allowed; }
        
        #sendBtn { background: #667eea; }
        #sendBtn:hover { background: #764ba2; }

        #addTaskBtn { background: #28a745; display: flex; align-items: center; gap: 5px; }
        #addTaskBtn:hover { background: #218838; }

        /* --- RECORDING STYLES --- */
        #recordBtn { background: #17a2b8; font-size: 16px; }
        #recordBtn:hover { background: #138496; }
        
        /* Animation for when recording is active */
        .recording {
            background-color: #dc3545 !important;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        /* --- MODAL STYLES --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 12px;
            width: 90%; max-width: 450px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s;
        }
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 4px; }
        .form-input { 
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; 
        }
        .row { display: flex; gap: 10px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Project Dashboard</h1>
        
        <div class="status-bar loading" id="statusBar">üîÑ Connecting...</div>
        
        <div class="chat-box" id="chatBox">
            <div class="message ai-message">
                Hi there! üëã<br>
                I am Live.<br>
                ‚Ä¢ Ask me about project status üìà<br>
                ‚Ä¢ Use the üé§ to speak<br>
                ‚Ä¢ Or click <b>Add Task</b> to create new entries!
            </div>
        </div>
        
        <div class="input-group">
            <input type="text" id="userInput" placeholder="Ask a question..." disabled onkeypress="if(event.key === 'Enter') sendMessage()">
            <!-- RECORD BUTTON ADDED HERE -->
            <button id="recordBtn" onclick="toggleRecording()" disabled>üé§</button>
            <button id="sendBtn" onclick="sendMessage()" disabled>Send</button>
            <button id="addTaskBtn" onclick="openModal()" disabled>‚ûï Add Task</button>
        </div>
    </div>

    <!-- NEW FULL FORM MODAL -->
    <div id="taskModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-bottom:20px; color:#333; border-bottom:1px solid #eee; padding-bottom:10px;">
                üìù Add New Task
            </h3>
            
            <div class="form-group">
                <label class="form-label">Task Name</label>
                <input type="text" id="t_name" class="form-input" placeholder="e.g. Design Homepage">
            </div>

            <div class="form-group">
                <label class="form-label">Client Name</label>
                <select id="t_client" class="form-input"> 
                    <option value="Batelco">Batelco</option>
                    <option value="Etisalat">Etisalat</option>
                    <option value="DU UAE">DU UAE</option>
                    <option value="Not Defined">Not Defined</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Assigned To</label>
                <input type="text" id="t_assign" class="form-input" placeholder="e.g. Rahul">
            </div>

            <div class="row">
                <div class="form-group" style="flex:1">
                    <label class="form-label">Start Date</label>
                    <input type="date" id="t_start" class="form-input">
                </div>
                <div class="form-group" style="flex:1">
                    <label class="form-label">End Date</label>
                    <input type="date" id="t_end" class="form-input">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Status</label>
                <select id="t_status" class="form-input">
                    <option value="Not Started">Not Started</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="On Hold">On Hold</option>
                </select>
            </div>

            <div class="form-group">
                <label for="notifyEmail">Notification Email (Optional)</label>
                <input type="email" id="notifyEmail" class="form-input" placeholder="jasneet.singh@airlinq.com">
                <small style="color: #666; font-size: 11px; margin-top: 4px; display:block;">
                   üìß If provided, an email will be sent immediately.
                </small>
            </div>

            <div class="modal-buttons" style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="submitTask()" style="flex:1; background:#28a745;">Save</button>
                <button onclick="closeModal()" style="flex:1; background:#dc3545;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://web-production-b8ca4.up.railway.app/";
        
        // Variables for Audio
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        window.addEventListener("load", checkStatus);

        function checkStatus() {
            fetch(`${API_URL}/api/status`)
                .then(r => r.json())
                .then(d => {
                    const sb = document.getElementById("statusBar");
                    if(d.document_loaded) {
                        sb.className = "status-bar ready"; sb.innerText = "‚úÖ System Ready";
                        toggleInput(true);
                    } else {
                        sb.className = "status-bar error"; sb.innerText = "‚ö†Ô∏è Connected, but Sheet is empty";
                        toggleInput(true);
                    }
                })
                .catch(() => {
                    document.getElementById("statusBar").innerText = "‚ùå Offline / Backend Error";
                });
        }

        function toggleInput(enable) {
            document.getElementById("userInput").disabled = !enable;
            document.getElementById("sendBtn").disabled = !enable;
            document.getElementById("addTaskBtn").disabled = !enable;
            document.getElementById("recordBtn").disabled = !enable;
        }

        // --- AUDIO LOGIC ---
        async function toggleRecording() {
            const btn = document.getElementById("recordBtn");

            if (!isRecording) {
                // START RECORDING
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        sendAudioToBackend(audioBlob);
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    btn.classList.add("recording"); // Turn red
                    addMessage("üé§ Listening...", "ai-message"); // Visual cue
                } catch (err) {
                    alert("Microphone access denied or error: " + err);
                }
            } else {
                // STOP RECORDING
                mediaRecorder.stop();
                isRecording = false;
                btn.classList.remove("recording");
            }
        }

        function sendAudioToBackend(blob) {
            toggleInput(false);
            
            // Create FormData to send file
            const formData = new FormData();
            formData.append("audio", blob, "recording.wav");

            // Assuming your backend has an /api/voice endpoint
            // If it uses the same /api/chat, you need to adjust this URL
            fetch(`${API_URL}/api/voice`, { 
                method: "POST",
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                // Remove the "Listening..." message (optional, or just add new response)
                addMessage(data.response, "ai-message");
                if(data.type === "table") renderTable(data.table_data);
                if(data.type === "chart") renderChart(data.chart_data);
            })
            .catch(e => {
                addMessage("‚ùå Error processing audio.", "ai-message");
                console.error(e);
            })
            .finally(() => {
                toggleInput(true);
            });
        }

        // --- CHAT LOGIC ---
        function sendMessage() {
            const input = document.getElementById("userInput");
            const txt = input.value.trim();
            if(!txt) return;

            addMessage(txt, "user-message");
            input.value = "";
            toggleInput(false);

            const loadId = addMessage("‚è≥ Thinking...", "ai-message");

            fetch(`${API_URL}/api/chat`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: txt })
            })
            .then(r => r.json())
            .then(data => {
                document.getElementById(loadId).remove();
                addMessage(data.response, "ai-message");
                if(data.type === "table") renderTable(data.table_data);
                if(data.type === "chart") renderChart(data.chart_data);
            })
            .catch(e => {
                document.getElementById(loadId).innerText = "Error: " + e;
            })
            .finally(() => {
                toggleInput(true);
                input.focus();
            });
        }

        // --- MODAL LOGIC ---
        function openModal() { document.getElementById("taskModal").style.display = "flex"; }
        function closeModal() { document.getElementById("taskModal").style.display = "none"; }

        function submitTask() {
            const name = document.getElementById("t_name").value;
            const assign = document.getElementById("t_assign").value;
            const start = document.getElementById("t_start").value;
            const end = document.getElementById("t_end").value;
            const status = document.getElementById("t_status").value;
            const client = document.getElementById("t_client").value;
            const notifyEmail = document.getElementById("notifyEmail").value;

            if (!name || !start) {
                alert("Please fill in at least Task Name and Start Date.");
                return;
            }

            closeModal();
            addMessage(`üõ† Adding task "${name}" for client "${client || 'Unknown'}"...`, "user-message");

            fetch(`${API_URL}/api/add-task`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    task_name: name,
                    assigned_to: assign,
                    start_date: start,
                    end_date: end,
                    status: status,
                    client: client,
                    notify_email: notifyEmail
                })
            })
            .then(r => {
                if(!r.ok) throw new Error("Backend error");
                return r.json();
            })
            .then(data => {
                addMessage("‚úÖ " + data.message, "ai-message");
                document.getElementById("t_name").value = "";
                document.getElementById("t_client").value = "";
                document.getElementById("t_assign").value = "";
            })
            .catch(e => {
                addMessage("‚ùå Failed to add task.", "ai-message");
                console.error(e);
            });
        }

        // --- RENDER HELPERS ---
        function addMessage(text, cls) {
            const div = document.createElement("div");
            div.className = "message " + cls;
            div.innerHTML = text.replace(/\n/g, "<br>");
            div.id = "msg-" + Date.now();
            const box = document.getElementById("chatBox");
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            return div.id;
        }

        function renderTable(data) {
            if (!data || !data.headers || !data.rows) {
                addMessage("‚ö†Ô∏è Received incomplete table data.", "ai-message");
                return;
            }

            const box = document.getElementById("chatBox");
            const div = document.createElement("div"); 
            div.className = "table-container";
            
            let html = `<table class="chat-table"><thead><tr>`;
            data.headers.forEach(header => { html += `<th>${header}</th>`; });
            html += `</tr></thead><tbody>`;
            
            data.rows.forEach(row => {
                html += `<tr>`;
                row.forEach(cell => { html += `<td>${cell || ''}</td>`; });
                html += `</tr>`;
            });
            
            html += `</tbody></table>`;
            div.innerHTML = html;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function renderChart(data) {
            if (!data || !data.data || !data.data.labels || !data.data.values) {
                addMessage("‚ö†Ô∏è Chart data is incomplete.", "ai-message");
                return;
            }

            const box = document.getElementById("chatBox");
            const div = document.createElement("div"); 
            div.className = "chart-container";
            
            const canvasId = "c-" + Date.now();
            const cvs = document.createElement("canvas"); 
            cvs.id = canvasId;
            cvs.style.maxHeight = "300px"; 
            
            div.appendChild(cvs); 
            box.appendChild(div); 
            box.scrollTop = box.scrollHeight;

            const backgroundColors = [
                '#667eea', '#764ba2', '#28a745', '#dc3545', 
                '#ffc107', '#17a2b8', '#fd7e14', '#6c757d'
            ];

            new Chart(document.getElementById(canvasId), {
                type: data.chart_type || 'bar',
                data: {
                    labels: data.data.labels,
                    datasets: [{
                        label: data.title,
                        data: data.data.values,
                        backgroundColor: backgroundColors.slice(0, data.data.values.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
    </script>
</body>
</html>
